name: DeployFrontend

on:
  push:
    branches:
      - Developement

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Set up SSH agent for Git access
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY_TESTING_SERVER  }}

      - name: Add GitHub to known_hosts
        run: ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Checkout repository using SSH
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: SSH Working
        run: |
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.DEV_SERVER_TESTING }} << 'EOF'
           #set -e  # Exit immediately if a command exits with a non-zero status
           # set -x  # Uncomment for debugging purposes

            echo "Navigating to deployment directory: ${{ secrets.DEPLOY_PATH }}"
            cd ${{ secrets.DEPLOY_PATH }}

            echo "Configuring Git to trust this repository globally."
            git config --global --add safe.directory "$PWD"

            # Check if the directory is a Git repository
            if [ -d ".git" ]; then
                echo "Git repository found. Checking out Developement branch and pulling latest changes."
            
                # Ensure we are on the correct branch
                git checkout Developement
                git pull origin Developement

            else
                echo "Git repository not found. Cloning repository."
            
                # Clone only the Development branch
                 git clone --single-branch --branch Developement git@github.com:AngelPbx/UcaaS-Frontend.git .
            fi

            echo "Listing deployment directory contents:"
            ls -la
            

          EOF
          echo "Deployment complete."
